{"ast":null,"code":"import _classCallCheck from\"C:/dev/streamlit-aggrid/st_aggrid/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"C:/dev/streamlit-aggrid/st_aggrid/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"C:/dev/streamlit-aggrid/st_aggrid/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"C:/dev/streamlit-aggrid/st_aggrid/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import{Streamlit,StreamlitComponentBase,withStreamlitConnection}from\"streamlit-component-lib\";import React from\"react\";import{AgGridReact}from'@ag-grid-community/react';import{ModuleRegistry}from'@ag-grid-community/core';import{AllCommunityModules}from'@ag-grid-community/all-modules';import{AllModules}from'@ag-grid-enterprise/all-modules';import{LicenseManager}from\"@ag-grid-enterprise/core\";// import '@ag-grid-community/core/dist/styles/ag-grid.css';\n// import '@ag-grid-community/core/dist/styles/ag-theme-balham.css';\n// import '@ag-grid-community/core/dist/styles/ag-theme-balham-dark.css';\n// import 'Agrid.scss'\nimport{parseISO,compareAsc}from'date-fns';import{format}from'date-fns-tz';import deepMap from\"./utils\";import{duration}from\"moment\";import'@ag-grid-community/core/dist/styles/ag-theme-blue.css';import'@ag-grid-community/core/dist/styles/ag-theme-fresh.css';import'@ag-grid-community/core/dist/styles/ag-theme-material.css';// import _ from 'lodash'\nimport'./AgGrid.scss';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var AgGrid=/*#__PURE__*/function(_StreamlitComponentBa){_inherits(AgGrid,_StreamlitComponentBa);var _super=_createSuper(AgGrid);function AgGrid(props){var _this2=this;var _this;_classCallCheck(this,AgGrid);_this=_super.call(this,props);_this.frameDtypes=void 0;_this.api=void 0;_this.columnApi=void 0;_this.columnFormaters=void 0;_this.manualUpdateRequested=false;_this.allowUnsafeJsCode=false;_this.fitColumnsOnGridLoad=false;_this.gridOptions=void 0;_this.convertJavascriptCodeOnGridOptions=function(obj){return deepMap(obj,_this.convertStringToFunction);};_this.render=function(){if(_this.api!==undefined){if(_this.state.should_update){_this.api.setRowData(_this.state.rowData);}}return/*#__PURE__*/_jsxs(\"div\",{className:\"ag-theme-\"+_this.props.args.theme,style:_this.defineContainerHeight(),children:[/*#__PURE__*/_jsx(_this2.ManualUpdateButton,{manual_update:_this.manualUpdateRequested,onClick:function onClick(e){return _this.returnGridValue(e);}}),/*#__PURE__*/_jsx(AgGridReact,{onGridReady:function onGridReady(e){return _this.onGridReady(e);},gridOptions:_this.gridOptions})]});};if(props.args.enable_enterprise_modules){ModuleRegistry.registerModules(AllModules);if('license_key'in props.args){LicenseManager.setLicenseKey(props.args['license_key']);}}else{ModuleRegistry.registerModules(AllCommunityModules);}_this.frameDtypes=_this.props.args.frame_dtypes;_this.manualUpdateRequested=_this.props.args.update_mode===1;_this.allowUnsafeJsCode=_this.props.args.allow_unsafe_jscode;_this.fitColumnsOnGridLoad=_this.props.args.fit_columns_on_grid_load;// let themes = {\n//   'streamlit':'ag-theme-streamlit',\n//   'light':'ag-theme-light',\n//   'dark':'ag-theme-dark',\n//   'blue':'ag-theme-blue',\n//   'fresh':'ag-theme-fresh',\n//   'material':'ag-theme-material',\n// }\n_this.columnFormaters={columnTypes:{'dateColumnFilter':{filter:'agDateColumnFilter',filterParams:{comparator:function comparator(filterValue,cellValue){return compareAsc(parseISO(cellValue),filterValue);}}},'numberColumnFilter':{filter:'agNumberColumnFilter'},'shortDateTimeFormat':{valueFormatter:function valueFormatter(params){return _this.dateFormatter(params.value,\"dd/MM/yyyy HH:mm\");}},'customDateTimeFormat':{valueFormatter:function valueFormatter(params){return _this.dateFormatter(params.value,params.column.colDef.custom_format_string);}},'customNumericFormat':{valueFormatter:function valueFormatter(params){var _params$column$colDef;return _this.numberFormatter(params.value,(_params$column$colDef=params.column.colDef.precision)!==null&&_params$column$colDef!==void 0?_params$column$colDef:2);}},'customCurrencyFormat':{valueFormatter:function valueFormatter(params){return _this.currencyFormatter(params.value,params.column.colDef.custom_currency_symbol);}},'timedeltaFormat':{valueFormatter:function valueFormatter(params){return duration(params.value).humanize(true);}}}};var gridOptions=Object.assign({},_this.columnFormaters,_this.props.args.gridOptions);if(_this.allowUnsafeJsCode){console.warn(\"flag allow_unsafe_jscode is on.\");gridOptions=_this.convertJavascriptCodeOnGridOptions(gridOptions);}_this.gridOptions=gridOptions;_this.state={rowData:JSON.parse(props.args.row_data),gridHeight:_this.props.args.height,should_update:false};return _this;}_createClass(AgGrid,[{key:\"convertStringToFunction\",value:function convertStringToFunction(v){var JS_PLACEHOLDER=\"--x_x--0_0--\";var funcReg=new RegExp(\"\".concat(JS_PLACEHOLDER,\"\\\\s*(function\\\\s*.*)\\\\s*\").concat(JS_PLACEHOLDER));var match=funcReg.exec(v);if(match){var funcStr=match[1];// eslint-disable-next-line\nreturn new Function(\"return \"+funcStr)();}else{return v;}}},{key:\"setUpdateMode\",value:function setUpdateMode(){var _this3=this;if(this.manualUpdateRequested){return;//If manual update is set, no listeners will be added\n}var updateMode=this.props.args.update_mode;if((updateMode&2)===2){this.api.addEventListener('cellValueChanged',function(e){return _this3.returnGridValue(e);});}if((updateMode&4)===4){this.api.addEventListener('selectionChanged',function(e){return _this3.returnGridValue(e);});}if((updateMode&8)===8){this.api.addEventListener('filterChanged',function(e){return _this3.returnGridValue(e);});}if((updateMode&16)===16){this.api.addEventListener('sortChanged',function(e){return _this3.returnGridValue(e);});}}},{key:\"onGridReady\",value:function onGridReady(event){var _this4=this;this.api=event.api;this.columnApi=event.columnApi;this.setUpdateMode();this.api.addEventListener('firstDataRendered',function(e){return _this4.fitColumns();});this.api.setRowData(this.state.rowData);for(var idx in this.gridOptions['preSelectedRows']){this.api.selectIndex(this.gridOptions['preSelectedRows'][idx],true,true);}}},{key:\"fitColumns\",value:function fitColumns(){if(this.fitColumnsOnGridLoad){this.api.sizeColumnsToFit();}else{this.columnApi.autoSizeAllColumns();}}},{key:\"dateFormatter\",value:function dateFormatter(isoString,formaterString){try{var date=parseISO(isoString);return format(date,formaterString);}catch(_unused){return isoString;}finally{}}},{key:\"currencyFormatter\",value:function currencyFormatter(number,currencySymbol){var n=Number.parseFloat(number);if(!Number.isNaN(n)){return currencySymbol+n.toFixed(2);}else{return number;}}},{key:\"numberFormatter\",value:function numberFormatter(number,precision){var n=Number.parseFloat(number);if(!Number.isNaN(n)){return n.toFixed(precision);}else{return number;}}},{key:\"returnGridValue\",value:function returnGridValue(e){var returnData=[];var returnMode=this.props.args.data_return_mode;switch(returnMode){case 0://ALL_DATA\nthis.api.forEachLeafNode(function(row){return returnData.push(row.data);});break;case 1://FILTERED_DATA\nthis.api.forEachNodeAfterFilter(function(row){if(!row.group){returnData.push(row.data);}});break;case 2://FILTERED_SORTED_DATA\nthis.api.forEachNodeAfterFilterAndSort(function(row){if(!row.group){returnData.push(row.data);}});break;}var returnValue={originalDtypes:this.frameDtypes,rowData:returnData,selectedRows:this.api.getSelectedRows()};Streamlit.setComponentValue(returnValue);}},{key:\"ManualUpdateButton\",value:function ManualUpdateButton(props){if(props.manual_update){return/*#__PURE__*/_jsx(\"button\",{onClick:props.onClick,children:\"Update\"});}else{return/*#__PURE__*/_jsx(\"span\",{});}}},{key:\"defineContainerHeight\",value:function defineContainerHeight(){if('domLayout'in this.gridOptions){if(this.gridOptions['domLayout']==='autoHeight'){return{width:this.props.width};}}return{width:this.props.width,height:this.state.gridHeight};}}],[{key:\"getDerivedStateFromProps\",value:function getDerivedStateFromProps(props,state){if(props.args.reload_data){// let old_row_data = state.rowData\nvar new_row_data=JSON.parse(props.args.row_data);//let should_update = _.isEqual(_.map(old_row_data, (v) => Object.keys(v)), _.map(new_row_data, (v) => Object.keys(v)))\nreturn{rowData:new_row_data,gridHeight:props.args.height,should_update:true};}else{return{gridHeight:props.args.height};}}}]);return AgGrid;}(StreamlitComponentBase);// \"withStreamlitConnection\" is a wrapper function. It bootstraps the\n// connection between your component and the Streamlit app, and handles\n// passing arguments from Python -> Component.\n//\n// You don't need to edit withStreamlitConnection (but you're welcome to!).\nexport default withStreamlitConnection(AgGrid);","map":{"version":3,"sources":["C:/dev/streamlit-aggrid/st_aggrid/frontend/src/AgGrid.tsx"],"names":["Streamlit","StreamlitComponentBase","withStreamlitConnection","React","AgGridReact","ModuleRegistry","AllCommunityModules","AllModules","LicenseManager","parseISO","compareAsc","format","deepMap","duration","AgGrid","props","frameDtypes","api","columnApi","columnFormaters","manualUpdateRequested","allowUnsafeJsCode","fitColumnsOnGridLoad","gridOptions","convertJavascriptCodeOnGridOptions","obj","convertStringToFunction","render","undefined","state","should_update","setRowData","rowData","args","theme","defineContainerHeight","e","returnGridValue","onGridReady","enable_enterprise_modules","registerModules","setLicenseKey","frame_dtypes","update_mode","allow_unsafe_jscode","fit_columns_on_grid_load","columnTypes","filter","filterParams","comparator","filterValue","cellValue","valueFormatter","params","dateFormatter","value","column","colDef","custom_format_string","numberFormatter","precision","currencyFormatter","custom_currency_symbol","humanize","Object","assign","console","warn","JSON","parse","row_data","gridHeight","height","v","JS_PLACEHOLDER","funcReg","RegExp","match","exec","funcStr","Function","updateMode","addEventListener","event","setUpdateMode","fitColumns","idx","selectIndex","sizeColumnsToFit","autoSizeAllColumns","isoString","formaterString","date","number","currencySymbol","n","Number","parseFloat","isNaN","toFixed","returnData","returnMode","data_return_mode","forEachLeafNode","row","push","data","forEachNodeAfterFilter","group","forEachNodeAfterFilterAndSort","returnValue","originalDtypes","selectedRows","getSelectedRows","setComponentValue","manual_update","onClick","width","reload_data","new_row_data"],"mappings":"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","sourcesContent":["import {\r\n  Streamlit,\r\n  StreamlitComponentBase,\r\n  withStreamlitConnection\r\n} from \"streamlit-component-lib\";\r\n\r\nimport React, { ReactNode } from \"react\"\r\n\r\nimport { AgGridReact } from '@ag-grid-community/react';\r\nimport { ColumnApi, GridApi } from '@ag-grid-community/core'\r\nimport { ModuleRegistry } from '@ag-grid-community/core';\r\nimport { AllCommunityModules } from '@ag-grid-community/all-modules'\r\nimport { AllModules } from '@ag-grid-enterprise/all-modules'\r\nimport { LicenseManager } from \"@ag-grid-enterprise/core\";\r\n\r\n// import '@ag-grid-community/core/dist/styles/ag-grid.css';\r\n// import '@ag-grid-community/core/dist/styles/ag-theme-balham.css';\r\n// import '@ag-grid-community/core/dist/styles/ag-theme-balham-dark.css';\r\n// import 'Agrid.scss'\r\n\r\nimport { parseISO, compareAsc } from 'date-fns'\r\nimport { format } from 'date-fns-tz'\r\nimport deepMap from \"./utils\"\r\nimport { duration } from \"moment\";\r\n\r\nimport '@ag-grid-community/core/dist/styles/ag-theme-blue.css';\r\nimport '@ag-grid-community/core/dist/styles/ag-theme-fresh.css';\r\nimport '@ag-grid-community/core/dist/styles/ag-theme-material.css';\r\n\r\n// import _ from 'lodash'\r\n\r\nimport'./AgGrid.scss'\r\n\r\ninterface State {\r\n  rowData: any\r\n  gridHeight: number\r\n  should_update: boolean\r\n}\r\n\r\nclass AgGrid extends StreamlitComponentBase<State> {\r\n  private frameDtypes: any\r\n  private api!: GridApi;\r\n  private columnApi!: ColumnApi\r\n  private columnFormaters: any\r\n  private manualUpdateRequested: boolean = false\r\n  private allowUnsafeJsCode: boolean = false\r\n  private fitColumnsOnGridLoad: boolean = false\r\n  private gridOptions: any\r\n\r\n  constructor(props: any) {\r\n    super(props)\r\n\r\n    if (props.args.enable_enterprise_modules) {\r\n      ModuleRegistry.registerModules(AllModules);\r\n      if ('license_key' in props.args) {\r\n        LicenseManager.setLicenseKey(props.args['license_key']);\r\n      }\r\n    } else {\r\n      ModuleRegistry.registerModules(AllCommunityModules);\r\n    }\r\n\r\n    this.frameDtypes = this.props.args.frame_dtypes\r\n    this.manualUpdateRequested = (this.props.args.update_mode === 1)\r\n    this.allowUnsafeJsCode = this.props.args.allow_unsafe_jscode\r\n    this.fitColumnsOnGridLoad = this.props.args.fit_columns_on_grid_load\r\n    \r\n    // let themes = {\r\n    //   'streamlit':'ag-theme-streamlit',\r\n    //   'light':'ag-theme-light',\r\n    //   'dark':'ag-theme-dark',\r\n    //   'blue':'ag-theme-blue',\r\n    //   'fresh':'ag-theme-fresh',\r\n    //   'material':'ag-theme-material',\r\n    // }\r\n\r\n    this.columnFormaters = {\r\n      columnTypes: {\r\n        'dateColumnFilter': {\r\n          filter: 'agDateColumnFilter',\r\n          filterParams: {\r\n            comparator: (filterValue: any, cellValue: string) => compareAsc(parseISO(cellValue), filterValue)\r\n          }\r\n        },\r\n        'numberColumnFilter': {\r\n          filter: 'agNumberColumnFilter'\r\n        },\r\n        'shortDateTimeFormat': {\r\n          valueFormatter: (params: any) => this.dateFormatter(params.value, \"dd/MM/yyyy HH:mm\"),\r\n        },\r\n        'customDateTimeFormat': {\r\n          valueFormatter: (params: any) => this.dateFormatter(params.value, params.column.colDef.custom_format_string),\r\n        },\r\n        'customNumericFormat': {\r\n          valueFormatter: (params: any) => this.numberFormatter(params.value, params.column.colDef.precision ?? 2),\r\n        },\r\n        'customCurrencyFormat': {\r\n          valueFormatter: (params: any) => this.currencyFormatter(params.value, params.column.colDef.custom_currency_symbol),\r\n        },\r\n        'timedeltaFormat': {\r\n          valueFormatter: (params: any) => duration(params.value).humanize(true)\r\n        },\r\n      }\r\n    }\r\n\r\n    let gridOptions = Object.assign({}, this.columnFormaters, this.props.args.gridOptions)\r\n\r\n    if (this.allowUnsafeJsCode) {\r\n      console.warn(\"flag allow_unsafe_jscode is on.\")\r\n      gridOptions = this.convertJavascriptCodeOnGridOptions(gridOptions)\r\n    }\r\n    this.gridOptions = gridOptions\r\n\r\n    this.state = {\r\n      rowData: JSON.parse(props.args.row_data),\r\n      gridHeight: this.props.args.height,\r\n      should_update: false\r\n    }\r\n  }\r\n\r\n  static getDerivedStateFromProps(props: any, state: any) {\r\n    if (props.args.reload_data) {\r\n      // let old_row_data = state.rowData\r\n      let new_row_data = JSON.parse(props.args.row_data)\r\n      //let should_update = _.isEqual(_.map(old_row_data, (v) => Object.keys(v)), _.map(new_row_data, (v) => Object.keys(v)))\r\n      return {\r\n        rowData: new_row_data,\r\n        gridHeight: props.args.height,\r\n        should_update: true\r\n      }\r\n    } else {\r\n      return {\r\n        gridHeight: props.args.height\r\n      }\r\n    }\r\n  }\r\n\r\n  private convertStringToFunction(v: string) {\r\n    const JS_PLACEHOLDER = \"--x_x--0_0--\"\r\n\r\n    let funcReg = new RegExp(\r\n      `${JS_PLACEHOLDER}\\\\s*(function\\\\s*.*)\\\\s*${JS_PLACEHOLDER}`\r\n    )\r\n\r\n    let match = funcReg.exec(v)\r\n\r\n    if (match) {\r\n      const funcStr = match[1]\r\n      // eslint-disable-next-line\r\n      return new Function(\"return \" + funcStr)()\r\n\r\n    } else {\r\n      return v\r\n    }\r\n  }\r\n\r\n  private convertJavascriptCodeOnGridOptions = (obj: object) => {\r\n    return deepMap(obj, this.convertStringToFunction)\r\n  }\r\n\r\n  private setUpdateMode() {\r\n    if (this.manualUpdateRequested) {\r\n      return //If manual update is set, no listeners will be added\r\n    }\r\n\r\n    let updateMode = this.props.args.update_mode\r\n\r\n    if ((updateMode & 2) === 2) {\r\n      this.api.addEventListener('cellValueChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n\r\n    if ((updateMode & 4) === 4) {\r\n      this.api.addEventListener('selectionChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n\r\n    if ((updateMode & 8) === 8) {\r\n      this.api.addEventListener('filterChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n\r\n    if ((updateMode & 16) === 16) {\r\n      this.api.addEventListener('sortChanged', (e: any) => this.returnGridValue(e))\r\n    }\r\n  }\r\n\r\n  private onGridReady(event: any) {\r\n    this.api = event.api\r\n    this.columnApi = event.columnApi\r\n\r\n    this.setUpdateMode()\r\n    this.api.addEventListener('firstDataRendered', (e: any) => this.fitColumns())\r\n\r\n    this.api.setRowData(this.state.rowData)\r\n\r\n    for (var idx in this.gridOptions['preSelectedRows']) {\r\n      this.api.selectIndex(this.gridOptions['preSelectedRows'][idx], true, true)\r\n    }\r\n  }\r\n\r\n  private fitColumns() {\r\n    if (this.fitColumnsOnGridLoad) {\r\n      this.api.sizeColumnsToFit()\r\n    }\r\n    else {\r\n      this.columnApi.autoSizeAllColumns()\r\n    }\r\n  }\r\n\r\n  private dateFormatter(isoString: string, formaterString: string): String {\r\n    try {\r\n      let date = parseISO(isoString)\r\n      return format(date, formaterString)\r\n    } catch {\r\n      return isoString\r\n    }\r\n    finally { }\r\n  }\r\n\r\n  private currencyFormatter(number: any, currencySymbol: string): String {\r\n    let n = Number.parseFloat(number)\r\n    if (!Number.isNaN(n)) {\r\n      return currencySymbol + n.toFixed(2)\r\n    } else {\r\n      return number\r\n    }\r\n  }\r\n\r\n  private numberFormatter(number: any, precision: number): String {\r\n    let n = Number.parseFloat(number)\r\n    if (!Number.isNaN(n)) {\r\n      return n.toFixed(precision)\r\n    } else {\r\n      return number\r\n    }\r\n  }\r\n\r\n  private returnGridValue(e: any) {\r\n    let returnData: any[] = []\r\n    let returnMode = this.props.args.data_return_mode\r\n\r\n    switch (returnMode) {\r\n      case 0: //ALL_DATA\r\n        this.api.forEachLeafNode((row) => returnData.push(row.data))\r\n        break;\r\n\r\n      case 1: //FILTERED_DATA\r\n        this.api.forEachNodeAfterFilter((row) => { if (!row.group) { returnData.push(row.data) } })\r\n        break;\r\n\r\n      case 2: //FILTERED_SORTED_DATA\r\n        this.api.forEachNodeAfterFilterAndSort((row) => { if (!row.group) { returnData.push(row.data) } })\r\n        break;\r\n    }\r\n\r\n    let returnValue = {\r\n      originalDtypes: this.frameDtypes,\r\n      rowData: returnData,\r\n      selectedRows: this.api.getSelectedRows()\r\n    }\r\n\r\n    Streamlit.setComponentValue(returnValue)\r\n  }\r\n\r\n  private ManualUpdateButton(props: any) {\r\n    if (props.manual_update) {\r\n      return (<button onClick={props.onClick}>Update</button>)\r\n    }\r\n    else {\r\n      return (<span></span>)\r\n    }\r\n  }\r\n\r\n  private defineContainerHeight() {\r\n    if ('domLayout' in this.gridOptions) {\r\n      if (this.gridOptions['domLayout'] === 'autoHeight') {\r\n        return ({\r\n          width: this.props.width\r\n        })\r\n      }\r\n    }\r\n    return ({\r\n      width: this.props.width,\r\n      height: this.state.gridHeight\r\n    })\r\n  }\r\n\r\n  public render = (): ReactNode => {\r\n\r\n    if (this.api !== undefined) {\r\n      if (this.state.should_update) {\r\n        this.api.setRowData(this.state.rowData)\r\n      }\r\n    }\r\n\r\n    return (\r\n      <div className={\"ag-theme-\"+ this.props.args.theme} style={this.defineContainerHeight()} >\r\n        <this.ManualUpdateButton manual_update={this.manualUpdateRequested} onClick={(e: any) => this.returnGridValue(e)} />\r\n        <AgGridReact\r\n          onGridReady={(e) => this.onGridReady(e)}\r\n          gridOptions={this.gridOptions}\r\n        >\r\n        </AgGridReact>\r\n      </div >\r\n    )\r\n  }\r\n}\r\n\r\n// \"withStreamlitConnection\" is a wrapper function. It bootstraps the\r\n// connection between your component and the Streamlit app, and handles\r\n// passing arguments from Python -> Component.\r\n//\r\n// You don't need to edit withStreamlitConnection (but you're welcome to!).\r\nexport default withStreamlitConnection(AgGrid)\r\n"]},"metadata":{},"sourceType":"module"}