"use strict";(self.webpackChunkmlprovlab=self.webpackChunkmlprovlab||[]).push([[814],{24814:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Z});var o=n(16753),l=n(82766),a=n(15775),r=n(45185),i=n(21396),c=n(56247);async function d(e="",t={}){const n=c.ServerConnection.makeSettings(),o=i.URLExt.join(n.baseUrl,"mlprovlab",e);let l;try{l=await c.ServerConnection.makeRequest(o,t,n)}catch(e){throw new c.ServerConnection.NetworkError(e)}let a=await l.text();if(a.length>0)try{a=JSON.parse(a)}catch(e){console.log("Not a JSON response body.",l)}if(!l.ok)throw new c.ServerConnection.ResponseError(l,a.message||a);return a}var s=n(23706),u=n(20230),p=n.n(u),m=n(28745),h=n.n(m),g=n(40714),v=n.n(g),x=n(85010);const f=(0,x.createState)(!1),b=(0,x.createState)(!1),y=(0,x.createState)(!1),E=(0,x.createState)(!1),_=(0,x.createState)({});var w={};const S=(0,x.createState)({});function k(){return w}var C={};function I(e,t,n,o,l,a=!1){n&&(a||f.get()?(e.max=(n.epochs.length-1).toString(),e.value=(n.epochs.length-1).toString(),t.max=(n.epochs[n.epochs.length-1].data.length-1).toString(),t.value=(n.epochs[n.epochs.length-1].data.length-1).toString(),_[l.id].set({epoch:{max:n.epochs.length-1,value:n.epochs.length-1},cell:{max:n.epochs[n.epochs.length-1].data.length-1,value:n.epochs[n.epochs.length-1].data.length-1}}),O(o,n.epochs.length-1,n.epochs[n.epochs.length-1].data.length-1,n,l)):(e.max=(n.epochs.length-1).toString(),t.max=(n.epochs[n.epochs.length-1].data.length-1).toString(),_[l.id].set({epoch:{max:n.epochs.length-1,value:e.value},cell:{max:n.epochs[parseInt(e.value)].data.length-1,value:t.value}})))}async function O(e,t,n,o,l){e.remove(e.elements());var a=o.epochs[t],r=a.cells,i=[];if(E.value){for(var c=a.data[n].cell_id,d=(s=l.content.model.cells.iter()).next();d&&d.metadata.toJSON().prov_id!=c;)d=s.next();for(let t=0;t<r.length;t++)if(r[t]==c){e.add({group:"nodes",data:{id:c,label:"Cell: "+(t+1).toString()},classes:d?"top-center":"top-center Deleted"});break}i.push(c)}else for(let t=0;t<r.length;t++){const o=r[t];for(let r=0;r<=n;r++)if(a.data[r].cell_id==o){var s;for(d=(s=l.content.model.cells.iter()).next();d&&d.metadata.toJSON().prov_id!=o;)d=s.next();e.add({group:"nodes",data:{id:o,label:"Cell: "+(t+1).toString()},classes:d?"top-center":"top-center Deleted"}),i.push(o);break}}var u=[];for(let e=0;e<i.length;e++){const t=i[e];for(let e=n;e>=0;e--){const n=a.data[e];if(n.cell_id==t){u.push({pos:e,cell:n});break}}}var p=[];u.forEach((n=>{p.push(T(e,n,a.data,t,r,l))})),await Promise.all(p),function(e){e.layout({name:"cose-bilkent",idealEdgeLength:150}).run()}(e);var m=[];e.$("node:childless").forEach((e=>{m.push(e.data().execution_count)})),S[l.id].set(m.sort(((e,t)=>e-t)))}async function T(e,t,n,o,l,a){var r=[],i=0!=t.cell.data_vars.length;for(let e=0;e<t.cell.remote.length;e++){const o=t.cell.remote[e];for(let e=t.pos;e>=0;e--){const t=n[e];if(t.local.includes(o)){(c=r.find((e=>e.execution_count==t.execution_count&&!e.import)))?c.vars.push(o):r.push({cell:t,dataSource:!1,vars:[o],execution_count:t.execution_count,pos:e,import:!1});break}if(b.get()&&t.imports.includes(o)){var c;(c=r.find((e=>e.execution_count==t.execution_count&&e.import)))?c.vars.push(o):r.push({cell:t,dataSource:!1,vars:[o],execution_count:t.execution_count,pos:e,import:!0});break}}}if(!e.$id(t.cell.cell_id)[0])for(let n=0;n<l.length;n++){const o=l[n];if(o==t.cell.cell_id){for(var d=a.content.model.cells.iter(),s=d.next();s&&s.metadata.toJSON().prov_id!=o;)s=d.next();e.add({group:"nodes",data:{id:t.cell.cell_id,label:"Cell: "+(n+1).toString()},classes:s?"top-center":"top-center Deleted"});break}}if(!e.$id(t.cell.cell_id+t.cell.execution_count.toString())[0]){var u="";0!=t.cell.data_vars.length&&(u+="DataSource"),0!=t.cell.cell_outputs.length&&(u+="Output"),"error"==t.cell.type&&(u+="Error"),e.add({group:"nodes",classes:u,data:{id:t.cell.cell_id+t.cell.execution_count.toString(),parent:t.cell.cell_id,execution_count:t.cell.execution_count,epoch:o,label:t.cell.execution_count.toString(),data_source:t.cell.data_vars}})}for(let c=0;c<r.length;c++){const d=r[c];var p=await T(e,{pos:d.pos-1,cell:d.cell},n,o,l,a);p&&(i=p),d.dataSource=p;for(let n=0;n<d.vars.length;n++){const l=d.vars[n];var m=t.cell.cell_id+t.cell.execution_count.toString()+d.cell.cell_id+d.execution_count.toString()+l,h=p?"DataSource ":"";h+=d.import?"Import":"",e.$id(m)[0]||t.cell.execution_count==d.execution_count||e.add({group:"edges",classes:h,data:{id:m,target:t.cell.cell_id+t.cell.execution_count.toString(),source:d.cell.cell_id+d.execution_count.toString(),execution_count:d.execution_count.toString(),epoch:o,source_id:d.cell.cell_id,label:l}})}}return i}p().use(v());var N=n(66143),z=n(56271),R=n.n(z),J=n(92188),L=n.n(J),H=n(18848),M=n.n(H);function W(e){const[t,n]=(0,z.useState)(e.data.length-1);return R().createElement("div",{style:{width:"100%",height:"100%"}},R().createElement("div",{style:{overflow:"auto",width:"100%",height:"calc(100% - 30px)"}},R().createElement(M(),{leftTitle:"Code at epoch "+e.epoch[t]+" with execution count "+e.data[t].execution_count,rightTitle:"Code at epoch "+e.epoch[e.data.length-1]+" with execution count "+e.execution_count,showDiffOnly:!1,newValue:e.data[e.data.length-1].cell_source.toString(),oldValue:e.data[t].cell_source.toString()})),R().createElement("div",{style:{display:"flex",flexDirection:"row",flexWrap:"nowrap",height:"30px"}},R().createElement("div",{style:{flexGrow:0,paddingLeft:"10px"}},R().createElement("p",{style:{height:"30px",lineHeight:"20px"}},"Changes: ")),R().createElement("div",{style:{flexGrow:1,paddingLeft:"10px",paddingRight:"10px"}},R().createElement("input",{type:"range",defaultValue:t,onInput:e=>{n(e.target.value)},style:{width:"100%"},step:1,min:0,max:e.data.length-1}))))}function D(e){const t=e.notebook.context.model.metadata.toJSON().provenance,n={flexGrow:0,userSelect:"none",paddingLeft:"10px",paddingRight:"10px",color:"black",borderRight:"1px solid grey",lineHeight:"30px",fontSize:"13px"},[o,l]=(0,z.useState)(!1),[a,r]=(0,z.useState)(""),i=(0,x.useHookstate)(_[e.notebook.id]);return R().createElement("div",{style:{width:"100%",height:"100%",position:"relative"}},t?R().createElement("div",{style:{width:"100%",top:"31px",left:"0",position:"absolute",borderBottom:"1px solid grey",backgroundColor:"white",zIndex:1,display:o?"initial":"none"}},"Help"==a?R().createElement(P,null):null,"Options"==a?R().createElement(G,{notebook:e.notebook,menuToggle:l}):null,"Environment"==a&&i.value?R().createElement(V,{epoch:i.value.epoch.value,notebook:e.notebook}):null,"Import"==a&&i.value?R().createElement(A,{epoch:i.value.epoch.value,notebook:e.notebook}):null,"General"==a&&i.value?R().createElement(Y,{notebook:e.notebook}):null):null,R().createElement("div",{style:{height:"30px",borderBottom:"1px solid grey",width:"100%",display:"flex",flexDirection:"row",position:"relative"}},R().createElement("div",{style:n,onClick:()=>{l(!o),r("Options")}},"Options"),R().createElement("div",{style:n,onClick:()=>{var n,o;t&&("MLPovLabExport.json",n=function(e){var t=e.context.model.metadata.toJSON().provenance,n={used_data:[],epochs:[]};for(let e=0;e<t.epochs.length;e++){const a=t.epochs[e];var o={kernel_start_time:a.environment.time,language:a.environment.language_info.name,language_version:a.environment.language_info.version,language_mimetype:a.environment.language_info.mimetype,kernel:a.environment.kernel.implementation,kernel_version:a.environment.kernel.version,user_agent:a.environment.user_agent,modules:a.modules,execution_data:[]};for(let e=0;e<a.data.length;e++){const t=a.data[e];t.data_values.forEach((e=>n.used_data.includes(e)?null:n.used_data.push(e)));var l={execution_count:t.execution_count,used_data:t.data_values,data_vars:t.data_vars,execution_info:t.definitions,code:t.cell_source,cell_id:t.cell_id,dependencies:t.remote,imports:t.imports,outputs:t.cell_outputs,definitions:t.local,definition_info:t.local_info,time:t.time};o.execution_data.push(l)}n.epochs.push(o)}return JSON.stringify(n)}(e.notebook),(o=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),o.setAttribute("download","MLPovLabExport.json"),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o))}},"Export"),R().createElement("div",{style:n,onClick:()=>{l(!o),r("Environment")}},"Environment info"),R().createElement("div",{style:n,onClick:()=>{l(!o),r("Import")}},"Import info"),R().createElement("div",{style:n,onClick:()=>{e.app.commands.execute("prov-notebook:open",{path:e.notebook.context.path})}},"Code info"),R().createElement("div",{style:n,onClick:()=>{l(!o),r("General")}},"General info"),R().createElement("div",{style:n,onClick:()=>{l(!o),r("Help")}},"Help")),R().createElement("div",{style:{width:"100%",height:"calc(100% - 90px)"},id:"cytoscape-"+e.widget_id}),R().createElement(B,{notebook:e.notebook,widget_id:e.widget_id}))}function B(e){const t=e.notebook.context.model.metadata.toJSON().provenance,n=(0,x.useHookstate)(_[e.notebook.id]);return R().createElement(R().Fragment,null,R().createElement("div",{style:{display:"flex",flexDirection:"row",flexWrap:"nowrap",height:"30px"}},R().createElement("div",{style:{flexGrow:0,paddingLeft:"10px",minWidth:"100px"}},n.value?R().createElement("p",{style:{height:"30px",lineHeight:"20px"}},"Epoch"," ",R().createElement("b",{style:{float:"right"}},n.value.epoch.value+1,"/",n.value.epoch.max+1)):null),R().createElement("div",{style:{flexGrow:1,paddingLeft:"10px",paddingRight:"10px"}},R().createElement("input",{style:{width:"100%"},id:"prov-epoch-slider-"+e.widget_id,type:"range",min:0,step:1,defaultValue:0})),R().createElement("div",{style:{flexGrow:0,paddingLeft:"10px",paddingRight:"10px",minWidth:"200px"}},n.value&&t?R().createElement("p",{style:{height:"30px",lineHeight:"20px"}},t.epochs[n.value.epoch.value].environment.time):null)),R().createElement("div",{style:{display:"flex",flexDirection:"row",flexWrap:"nowrap",height:"30px"}},R().createElement("div",{style:{flexGrow:0,paddingLeft:"10px",minWidth:"100px"}},n.value?R().createElement("p",{style:{height:"30px",lineHeight:"20px"}},"Execution"," ",R().createElement("b",{style:{float:"right"}},n.value.cell.value+1,"/",n.value.cell.max+1)):null),R().createElement("div",{style:{flexGrow:1,paddingLeft:"10px",paddingRight:"10px"}},R().createElement("input",{style:{width:"100%"},id:"prov-cell-slider-"+e.widget_id,type:"range",min:0,step:1,defaultValue:0})),R().createElement("div",{style:{flexGrow:0,paddingLeft:"10px",paddingRight:"10px",minWidth:"200px"}},n.value&&t?R().createElement("p",{style:{height:"30px",lineHeight:"20px"}},t.epochs[n.value.epoch.value].data[n.value.cell.value].time):null)))}function P(){return R().createElement("div",{style:{width:"100%",maxHeight:"400px",overflowY:"auto",padding:"10px"}},R().createElement("p",null,R().createElement("b",null,"Colours:"),R().createElement("br",null)," ",R().createElement("span",{style:{color:"orange"}},"☗")," A execution is coloured orange if a data source was detected. Edges are orange if they in any way depend on those sources. ",R().createElement("br",null)," ",R().createElement("span",{style:{color:"green"}},"☗")," Executions are green if they have any sort of output. ",R().createElement("br",null)," ",R().createElement("span",{style:{color:"red"}},"☗")," A cell group is red if the corresponding cell was deleted. Also executions are red if they ended in an error. ",R().createElement("br",null)," ",R().createElement("b",null,"Context menu:")," ",R().createElement("br",null)," When you right click an entity in the graph a context menu will show up. From there you can open other widgets to see outputs or information about an execution or specific definition. You can also focus a cell when opening the context menu for cell groups."))}function V(e){const t=e.notebook.context.model.metadata.toJSON().provenance.epochs[e.epoch].environment,n="5px";return R().createElement("div",{style:{padding:"10px"}},R().createElement("p",null," ",R().createElement("b",null," Environment information of epoch ",e.epoch+1)),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"Language:")," ",t.language_info.name),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"Version:")," ",t.language_info.version),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"Mimetype: "),t.language_info.mimetype),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"Kernel start time:")," ",t.time),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"Kernel implementation: "),t.kernel.implementation),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"Kernel version:")," ",t.kernel.version),R().createElement("p",{style:{paddingTop:n}},R().createElement("b",null,"User agent:")," ",t.user_agent))}function A(e){const t=e.notebook.context.model.metadata.toJSON().provenance,n=t.epochs[e.epoch].modules,o=t.epochs[e.epoch].data,l={};for(let e=0;e<o.length;e++){const t=o[e];for(let e=0;e<t.imports.length;e++){const n=t.imports[e];void 0===l[n]&&(l[n]=JSON.stringify(t.definitions).split('"'+n+'"').length-1)}for(let e=0;e<t.local.length;e++){const n=t.local[e];void 0!==l[n]&&(l[n]+=1)}for(let e=0;e<t.remote.length;e++){const n=t.remote[e];void 0!==l[n]&&(l[n]+=1)}}const a="10px",r="1px solid grey",i="1px dotted grey";return R().createElement("div",{style:{width:"100%",maxHeight:"400px",overflowY:"auto"}},R().createElement("div",{style:{width:"100%",padding:a,boxSizing:"border-box",backgroundColor:"rgba(0, 0, 0, 0.05)"}},R().createElement("p",null,"Info about imports and modules in epoch ",R().createElement("b",null,e.epoch+1))),Object.keys(n).map(((e,t)=>R().createElement("div",{style:{width:"100%"},key:t},void 0===n[e].alias&&void 0===n[e].imports?R().createElement("div",{style:{width:"100%",borderTop:r,padding:a,boxSizing:"border-box",backgroundColor:0==l[e]?"rgba(255,0,0,0.2)":""}},R().createElement("p",null,"Import ",R().createElement("b",null,e)," ",""!=n[e].version?"version "+n[e].version:null," ","was used ",R().createElement("b",null,l[e])," times")):null,void 0!==n[e].alias?R().createElement("div",{style:{width:"100%",borderTop:r,padding:a,boxSizing:"border-box",backgroundColor:0==l[n[e].alias]?"rgba(255,0,0,0.2)":""}},R().createElement("p",null,"Import ",R().createElement("b",null,e)," ",""!=n[e].version?"version "+n[e].version:null," ","with alias ",R().createElement("b",null,n[e].alias," ")," was used"," ",R().createElement("b",null,l[n[e].alias])," times")):null,void 0!==n[e].imports?R().createElement("div",{style:{width:"100%"}},R().createElement("div",{style:{width:"100%",borderTop:r,padding:a,boxSizing:"border-box"}},R().createElement("p",null,"Imports from module ",R().createElement("b",null,e),":")),n[e].imports.map(((t,o)=>R().createElement("div",{style:{width:"100%",paddingLeft:"20px",borderTop:i,paddingBottom:a,paddingRight:a,paddingTop:a,boxSizing:"border-box",backgroundColor:0==l[t]?"rgba(255,0,0,0.2)":""},key:o},"string"==typeof t?R().createElement("div",{style:{width:"100%"}},R().createElement("p",null,"Import ",R().createElement("b",null,t)," ",""!=n[e].version?"version "+n[e].version:null," ","was used ",R().createElement("b",null,l[t])," times")):null,"object"==typeof t?R().createElement("div",{style:{width:"100%",paddingLeft:"20px",borderTop:i,paddingBottom:a,paddingRight:a,paddingTop:a,boxSizing:"border-box",backgroundColor:0==l[t]?"rgba(255,0,0,0.2)":""}},R().createElement("p",null,"Import ",R().createElement("b",null," ",t.name)," with alias"," ",R().createElement("b",null,t.alias)," was used ",R().createElement("b",null,l[t])," ","times")):null)))):null))))}function G(e){const t=(0,x.useHookstate)(b);return R().createElement("div",null,R().createElement("div",{style:{width:"100%",maxHeight:"400px",overflowY:"auto"}},R().createElement("div",{style:{width:"100%",padding:"10px",borderBottom:"1px solid grey",boxSizing:"border-box"}},R().createElement("input",{style:{marginRight:"10px"},type:"checkbox",defaultChecked:t.get(),onChange:e=>t.set(e.target.checked)}),R().createElement("label",null,"Show imports in graph")),R().createElement("div",{style:{width:"100%",padding:"10px",borderBottom:"1px solid grey",boxSizing:"border-box"}},R().createElement("input",{style:{marginRight:"10px"},type:"checkbox",defaultChecked:y.get(),onChange:e=>y.set(e.target.checked)}),R().createElement("label",null,"Zoom to cell nodes on select")),R().createElement("div",{style:{width:"100%",padding:"10px",borderBottom:"1px solid grey",boxSizing:"border-box"}},R().createElement("input",{style:{marginRight:"10px"},type:"checkbox",defaultChecked:E.value,onChange:e=>E.set(e.target.checked)}),R().createElement("label",null,"Only show dependencies of the selected execution")),R().createElement("div",{style:{width:"100%",padding:"10px",borderBottom:"1px solid grey",boxSizing:"border-box"}},R().createElement("input",{style:{marginRight:"10px"},type:"checkbox",defaultChecked:f.value,onChange:e=>f.set(e.target.checked)}),R().createElement("label",null,"Rebuild the graph automatically if new data is captured")),R().createElement("div",{style:{width:"100%",padding:"10px",boxSizing:"border-box"},onClick:()=>{confirm("Are you sure you want to delete the collected provenance data for your notebook?\n\nIf so be sure that you exported the collected data first!")&&(e.notebook.model.metadata.delete("provenance"),e.notebook.context.save(),e.menuToggle(!1))}},"Remove provenance data in case notebook size is to big (export your data first)")))}function j(e){const t=(0,x.useHookstate)([]),n=(0,x.useHookstate)(!0);return(0,z.useEffect)((()=>{e.infoElements&&t.set(e.infoElements.map((e=>!0)))}),[]),e.cell?R().createElement("div",{style:{height:"100%",width:"100%",boxSizing:"border-box",overflowY:"auto"}},R().createElement("div",{style:{width:"100%",boxSizing:"border-box",borderBottom:"1px solid grey"}},R().createElement("div",{style:{width:"100%",boxSizing:"border-box",padding:"10px",backgroundColor:"rgba(0, 0, 0, 0.05)"}},"Execution info of execution ",R().createElement("b",null," ",e.cell.execution_count," ")," at epoch ",R().createElement("b",null," ",e.epoch," "))),0!=t.length?e.infoElements.map(((e,n)=>R().createElement("div",{style:{width:"100%",boxSizing:"border-box",borderBottom:t.length-1==n?"1px solid grey":""},key:n},R().createElement("div",{style:{width:"100%",boxSizing:"border-box",padding:"10px",borderTop:0==n?"":"1px solid grey",borderBottom:t[n].value?"":"1px dotted grey"},onClick:()=>{t[n].set(!t[n].value)}},"Definition info: ",R().createElement("b",null," ",e.name," ")),R().createElement("div",{style:{width:"100%",boxSizing:"border-box",padding:"10px",display:t[n].value?"none":"initial"},dangerouslySetInnerHTML:{__html:e.text}})))):null,e.outputElement?R().createElement("div",{style:{width:"100%",boxSizing:"border-box",borderBottom:"1px solid grey"}},R().createElement("div",{style:{width:"100%",boxSizing:"border-box",padding:"10px",borderBottom:n.value?"":"1px dotted grey"},onClick:()=>{n.set(!n.value)}},R().createElement("b",null,"Cell output")),R().createElement("div",{style:{width:"100%",boxSizing:"border-box",padding:"10px",display:n.value?"none":"initial"},dangerouslySetInnerHTML:{__html:e.outputElement}})):null):R().createElement("div",null)}function $(e){const[t,n]=(0,z.useState)([]),o=(0,x.useHookstate)(_[e.notebookPanel.id]),l=(0,x.useHookstate)(S[e.notebookPanel.id]),[r,i]=(0,z.useState)([]);return(0,z.useEffect)((()=>{var t=e.notebookPanel.context.model.metadata.toJSON().provenance.epochs[o.get().epoch.value],r=[],c=[];Array.isArray(l.get())&&(l.get().forEach((e=>{for(let n=0;n<=o.get().cell.value;n++){const o=t.data[n];if(o.execution_count==e){if(r.push({source:o.cell_source.toString(),execution:e}),0!=o.cell_outputs.length){let e=new a.SimplifiedOutputArea({model:new a.OutputAreaModel({values:o.cell_outputs}),rendermime:C}).node.outerHTML;c.push(e)}else c.push(null);break}}})),n(r),i(c))}),[o.get().epoch.value,o.get().cell.value]),R().createElement("div",{style:{width:"100%",height:"100%",overflowY:"auto",margin:"0px"}},t.map(((e,t)=>R().createElement(R().Fragment,null,R().createElement("div",{style:{width:"100%",padding:"10px",boxSizing:"border-box"}},R().createElement("p",null,R().createElement("b",null,"Execution ",e.execution))),R().createElement(L(),{key:t,language:"python",customStyle:{margin:"0px"}},e.source),r[t]?R().createElement("div",{dangerouslySetInnerHTML:{__html:r[t]}}):null))))}function Y(e){const[t,n]=(0,z.useState)([]),o=(0,x.useHookstate)(_[e.notebook.id]);return(0,z.useEffect)((()=>{var t=e.notebook.context.model.metadata.toJSON().provenance,l=[];t.epochs[o.get().epoch.value].data.forEach((e=>{0!=e.data_values.length&&e.data_values.forEach(((t,n)=>{l.push({execution:e.execution_count,variable:e.data_vars[n],source:t})}))})),n(l)}),[o.get().epoch.value]),R().createElement("div",{style:{width:"100%",maxHeight:"400px",overflowY:"auto"}},t.map(((e,t)=>R().createElement("div",{style:{boxSizing:"border-box",width:"100%",padding:"10px",borderBottom:t==e.length-1?"1px solid grey":""}},"Source ",R().createElement("b",null,e.source)," was first used in execution"," ",R().createElement("b",null,e.execution)," in variable ",R().createElement("b",null,e.variable)))))}class U{constructor(e){this.app=e}createNew(e,t){let n=new r.ToolbarButton({label:"MLProvLab",onClick:()=>{this.app.commands.execute("prov-tracking:open")}});return e.toolbar.insertItem(10,"mybutton",n),n}}class F extends r.MainAreaWidget{constructor(e,t){super(t),this.nbPath=e}}class q extends r.MainAreaWidget{constructor(e,t,n,o,l){super(t),this.nbPath=e,this.epoch=n,this.cell_id=o,this.execution_count=l}}class K extends q{constructor(e,t,n,o,l,a){super(e,t,n,o,l),this.variable=a}}const Z={id:"mlprovlab:plugin",autoStart:!0,requires:[o.ILayoutRestorer,l.INotebookTracker,N.IRenderMimeRegistry],activate:(e,t,n,o)=>{e.docRegistry.addWidgetExtension("Notebook",new U(e)),C=o;var l=0,i=0,c={},u={},m={},g={},v={};const x=function(e){const t=function(t,n){if("send"==n.direction&&"execute_request"==n.msg.header.msg_type){for(var o,a=e.content.model.cells.iter(),r=a.next();r&&r.id!=n.msg.metadata.cellId;)r=a.next();for(c[r.id]=[],m[n.msg.header.msg_id]=r.id;!o;)o=u[r.id].local;var d=[];if(o!=[])for(let t=0;t<o.length;t++){const n=o[t];d.push(e.sessionContext.session.kernel.requestInspect({code:n.trim(),cursor_pos:0,detail_level:1}))}const t=async function(){var e,t;try{for(var n,o=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},o("next"),o("throw"),o("return"),t[Symbol.asyncIterator]=function(){return this},t);function o(n){t[n]=e[n]&&function(t){return new Promise((function(o,l){!function(e,t,n,o){Promise.resolve(o).then((function(t){e({value:t,done:n})}),t)}(o,l,(t=e[n](t)).done,t.value)}))}}}(d);!(n=await o.next()).done;){var l=n.value;if(l.content.data["text/plain"]){var a=l.content.data["text/plain"].split(/(\u001b\[1;31m[\w\s]+:\u001b\[0m)/),i="";for(let e=1;e<a.length;e+=2){const t=a[e];-1==t.search("Source:")&&-1==t.search("Class docstring:")&&(i+=t+a[e+1])}c[r.id].push(i)}else c[r.id].push("")}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=o.return)&&await t.call(o)}finally{if(e)throw e.error}}};g[n.msg.header.msg_id]=t()}if("recv"==n.direction&&"execute_reply"==n.msg.header.msg_type&&("error"==n.msg.content.status||"ok"==n.msg.content.status)){var s=l;l+=1;const t=async function(){for(var t,o=e.content.model.cells.iter(),l=o.next(),a=n.msg.content.execution_count;l&&l.id!=m[n.msg.parent_header.msg_id];)l=o.next();var r,d,p=!1,h=[],x=[],f=[],b=[],y={},E=[],_=[],w=(new Date).toUTCString();if("code"===l.toJSON().cell_type){var S=u[l.id];if(d=S.definitions,h=S.local,x=S.remote,f=S.imports,b=S.modules,E=S.data_vars,_=S.data_values,await g[n.msg.parent_header.msg_id],h!=[])for(let e=0;e<h.length;e++)y[h[e]]=c[l.id][e];for(;i<s;)await new Promise((e=>setTimeout(e,100)));e.model.metadata.has("provenance")?t=e.model.metadata.toJSON().provenance:(t={epochs:[],cells:[]},p=!0),l.metadata.has("prov_id")?r=l.metadata.get("prov_id").toString():(l.metadata.set("prov_id",l.id),r=l.id),t.cells.includes(r)||t.cells.push(r);var k={cell_id:r,cell_source:l.toJSON().source,cell_outputs:l.toJSON().outputs,execution_count:a,type:"ok"==n.msg.content.status?"execution":"error",local:h,remote:x,imports:f,local_info:y,data_values:_,data_vars:E,definitions:d,time:w};i===s&&(1==a||p?(t.epochs.push({modules:b,data:[k],cells:[r],environment:{time:(new Date).toUTCString(),user_agent:navigator.userAgent,kernel:{implementation:v.implementation,version:v.implementation_version},language_info:{name:v.language_info.name,version:v.language_info.version,mimetype:v.language_info.mimetype}}}),e.model.metadata.set("provenance",t)):(t.epochs[t.epochs.length-1].cells.includes(r)||t.epochs[t.epochs.length-1].cells.push(r),t.epochs[t.epochs.length-1].data.push(k),b&&(t.epochs[t.epochs.length-1].modules=Object.assign(Object.assign({},t.epochs[t.epochs.length-1].modules),b)),e.model.metadata.set("provenance",t)),i+=1)}else{for(;i<s;)await new Promise((e=>setTimeout(e,100)));i+=1}};t()}"recv"==n.direction&&"kernel_info_reply"==n.msg.header.msg_type&&(v=n.msg.content)};e.content.activeCellChanged.connect((async function(t,n){if(void 0!==n){var o=n.model.metadata.toJSON(),l=k()[e.context.path];if(o.prov_id&&l)try{l.$(":selected").forEach((e=>{e.unselect()}));var a=l.$(`node[id="${o.prov_id}"]`)[0];a.select(),y.value&&l.fit(a,200)}catch(e){}}})),e.model.cells.changed.connect(((e,t)=>{t.newValues[0]&&(d("analyze",{body:JSON.stringify(t.newValues[0].toJSON().source.toString()),method:"POST"}).then((e=>{u[t.newValues[0].id]=e})).catch((e=>{console.error(`Error analyzing code (probably because you used ipython magic).\n${e}`)})),t.newValues[0].contentChanged.connect((e=>{d("analyze",{body:JSON.stringify(e.toJSON().source.toString()),method:"POST"}).then((t=>{u[e.id]=t})).catch((e=>{console.error(`Error analyzing code (probably because you used ipython magic).\n${e}`)}))})))})),e.context.sessionContext.kernelChanged.connect((async(e,n)=>{n.newValue.anyMessage.connect(t)}))};n.restored.then((()=>{n.forEach(x),n.widgetAdded.connect(((e,t)=>{x(t)}))}));const f="prov-tracking:open";e.commands.addCommand(f,{execute:t=>{var o,l,a,{title:i,id:c,path:d}=t;o=d?n.find((e=>e.context.path===d)):n.currentWidget,l=c||"provenance-widget-"+o.context.path;for(var s,u=e.shell.widgets(),m=u.next();m;)m.id==l?(s=m,m=void 0):m=u.next();if(!s||s.isDisposed){let t=o.context.model.metadata.toJSON().provenance;void 0!==t&&_[o.id].set({epoch:{max:0==t.epochs.length?t.epochs.length-1:0,value:0==t.epochs.length?t.epochs.length-1:0},cell:{max:0==t.epochs.length?t.epochs[t.epochs.length-1].data.length-1:0,value:0==t.epochs.length?t.epochs[t.epochs.length-1].data.length-1:0}});const n=r.ReactWidget.create(R().createElement(D,{widget_id:l,notebook:o,app:e}));(s=new F(d||o.context.path,{content:n})).title.label=i||"Provenance: "+o.title.label,s.title.closable=!0,s.id=l}if(S.has(s)||S.add(s),!s.isAttached){e.shell.add(s,"main",{mode:"split-right"});var g=function(e,t,n){p().use(h());var o=p()({container:document.getElementById(e),style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":16,"font-weight":"bold"}},{selector:".top-center",style:{"text-valign":"top","text-halign":"center","font-size":16,"font-weight":"bold","text-outline-color":"#fff","text-outline-width":2,"text-outline-opacity":.8}},{selector:"edge",style:{"target-arrow-shape":"triangle","curve-style":"bezier"}},{selector:"edge[label]",style:{label:"data(label)","text-rotation":"autorotate","text-margin-x":0,"text-margin-y":0,"font-size":16,"font-weight":"bold","text-outline-color":"#fff","text-outline-width":2,"text-outline-opacity":.8}},{selector:".DataSource",style:{"background-color":"orange","line-color":"orange","target-arrow-color":"orange"}},{selector:".Output",style:{"background-color":"green"}},{selector:".DataSourceOutput",style:{"background-fill":"linear-gradient","background-gradient-stop-colors":"green green orange orange","background-gradient-stop-positions":"49.8 49.9 50.1 50.2"}},{selector:".DataSourceError",style:{"background-fill":"linear-gradient","background-gradient-stop-colors":"orange orange red red","background-gradient-stop-positions":"49.8 49.9 50.1 50.2"}},{selector:".OutputError",style:{"background-color":"red"}},{selector:".DataSourceOutputError",style:{"background-fill":"linear-gradient","background-gradient-stop-colors":"orange orange red red","background-gradient-stop-positions":"49.8 49.9 50.1 50.2"}},{selector:".Error",style:{"background-color":"red"}},{selector:".Deleted",style:{"background-color":"red","background-opacity":.2}},{selector:".Import",style:{opacity:.6,"line-color":"#b3e3ff"}}]});let l={menuRadius:function(e){return 100},selector:"node,edge",commands:e=>e.isNode()&&0==e.children().length?[{fillColor:"rgba(200, 200, 200, 0.75)",content:"Show code differences",contentStyle:{},select:function(e){t.commands.execute("prov-diff:open",{click:!0,path:n,cell_id:e.data().parent,execution_count:e.data().execution_count,epoch:e.data().epoch})},enabled:!0},{fillColor:"rgba(200, 200, 200, 0.75)",content:"Show execution info",contentStyle:{},select:function(e){t.commands.execute("prov-info:open",{click:!0,path:n,cell_id:e.data().parent,execution_count:e.data().execution_count,epoch:e.data().epoch})},enabled:!0}]:e.isNode()&&0!=e.children().length&&!e.classes().includes("Deleted")?[{fillColor:"rgba(200, 200, 200, 0.75)",content:"Focus cell in notebook",contentStyle:{},select:function(e){t.commands.execute("prov-utils:focus-cell",{path:n,cell_id:e.data().id})},enabled:!0}]:e.isEdge()&&!e.classes().includes("Import")?[{fillColor:"rgba(200, 200, 200, 0.75)",content:"Show execution info",contentStyle:{},select:function(e){t.commands.execute("prov-info:open",{click:!0,path:n,cell_id:e.data().source_id,execution_count:e.data().execution_count,epoch:e.data().epoch,variable:e.data().label})},enabled:!0}]:[],fillColor:"rgba(0, 0, 0, 0.75)",activeFillColor:"rgba(1, 105, 217, 0.75)",activePadding:20,indicatorSize:24,separatorWidth:3,spotlightPadding:4,adaptativeNodeSpotlightRadius:!1,minSpotlightRadius:24,maxSpotlightRadius:38,openMenuEvents:"cxttapstart taphold",itemColor:"white",itemTextShadowColor:"transparent",zIndex:9999,atMouse:!1,outsideMenuCancel:!1};return o.cxtmenu(l),o}("cytoscape-"+l,e,d);a=Object.assign(Object.assign({},k()),{[o.context.path]:g}),w=a;var v=document.getElementById("prov-epoch-slider-"+l),x=document.getElementById("prov-cell-slider-"+l),f=o.context.model.metadata.toJSON().provenance;v.addEventListener("input",(e=>{!function(e,t,n,o,l){n&&(t.max=(n.epochs[parseInt(e.value)].data.length-1).toString(),t.value=(n.epochs[parseInt(e.value)].data.length-1).toString(),_[l.id].set({epoch:{max:parseInt(e.max),value:parseInt(e.value)},cell:{max:n.epochs[parseInt(e.value)].data.length-1,value:n.epochs[parseInt(e.value)].data.length-1}}),O(o,parseInt(e.value),n.epochs[parseInt(e.value)].data.length-1,n,l))}(v,x,o.context.model.metadata.toJSON().provenance,g,o)})),x.addEventListener("input",(e=>{!function(e,t,n,o,l){n&&(_[l.id].set({epoch:{max:parseInt(e.max),value:parseInt(e.value)},cell:{max:parseInt(t.max),value:parseInt(t.value)}}),O(o,parseInt(e.value),parseInt(t.value),n,l))}(v,x,o.context.model.metadata.toJSON().provenance,g,o)}));const t=(e,t)=>{t.newValue&&(void 0===t.oldValue&&"provenance"===t.key?I(v,x,t.newValue,g,o,!0):("provenance"===t.key&&t.oldValue.length===t.newValue.length||"provenance"===t.key&&t.oldValue.length!==t.newValue.length)&&I(v,x,t.newValue,g,o))};o.context.model.metadata.changed.connect(t),s.disposed.connect((()=>{o.context.model.metadata.changed.disconnect(t)})),f&&I(v,x,f,g,o,!0)}s.content.update(),e.shell.activateById(s.id)}});const b="prov-diff:open";e.commands.addCommand(b,{execute:t=>{var o,l,{title:a,id:i,path:c,cell_id:d,execution_count:u,epoch:p}=t;o=c?n.find((e=>e.context.path===c)):n.currentWidget,l=i||"provenance-diff-widget-"+o.context.path;for(var m,h=e.shell.widgets(),g=h.next();g;)g.id==l?(m=g,g=void 0):g=h.next();if(m&&m.dispose(),!m||m.isDisposed){var v=new s.Widget,x=o.context.model.metadata.toJSON().provenance;if(x){var f=x.epochs[parseInt(p.toString())].data.find((e=>e.execution_count==parseInt(u.toString()))),b=[f.cell_source.toString()],y=[],E=[];for(let e=0;e<p;e++){const t=x.epochs[e];for(let n=0;n<t.data.length;n++){const o=t.data[n];o.cell_id!=d||b.includes(o.cell_source.toString())||(b.push(o.cell_source.toString()),y.push(o),E.push(e))}}y.push(f),E.push(parseInt(p.toString())),v=r.ReactWidget.create(R().createElement(W,{data:y,epoch:E,execution_count:parseInt(u.toString())}))}else o.context.model.metadata.changed.connect(((t,n)=>{void 0===n.oldValue&&"provenance"===n.key&&(m&&m.dispose(),e.commands.execute("prov-diff:open",{title:a,id:i,path:c,cell_id:d,execution_count:u,epoch:p}))}));(m=c?new q(c,{content:v},p,d,u):new q(o.context.path,{content:v},parseInt(p.toString()),d,u)).title.label=a||"Difference: "+o.title.label,m.title.closable=!0,m.id=l}T.has(m)||T.add(m),m.isAttached||(e.shell.add(m,"main",{mode:"split-top"}),m.content.update(),e.shell.activateById(m.id))}});const E="prov-info:open";e.commands.addCommand(E,{execute:t=>{var l,i,{title:c,id:d,path:s,cell_id:u,execution_count:p,epoch:m,variable:h}=t;l=s?n.find((e=>e.context.path===s)):n.currentWidget,i=d||"provenance-info-widget-"+l.context.path;for(var g,v=e.shell.widgets(),x=v.next();x;)x.id==i?(g=x,x=void 0):x=v.next();if(g&&g.dispose(),!g||g.isDisposed){var f=l.context.model.metadata.toJSON().provenance;if(f){var b,y=f.epochs[parseInt(m.toString())].data.find((e=>e.execution_count==parseInt(p.toString()))),E=[];if(h){var _="";_=y.local_info[h];var w=o.preferredMimeType({"text/plain":_},"prefer"),S=o.createRenderer(w),k=o.createModel({data:{"text/plain":_}});S.renderModel(k),S.addClass("prov-info"),E.push({text:S.node.outerHTML,name:h.toString()})}else for(let e=0;e<Object.keys(y.local_info).length;e++){const t=Object.keys(y.local_info)[e];_="",_+=y.local_info[t],w=o.preferredMimeType({"text/plain":_},"prefer"),S=o.createRenderer(w),k=o.createModel({data:{"text/plain":_}}),S.renderModel(k),S.addClass("prov-info"),E.push({text:S.node.outerHTML,name:t})}0!=y.cell_outputs.length&&(b=new a.SimplifiedOutputArea({model:new a.OutputAreaModel({values:y.cell_outputs}),rendermime:o}).node.outerHTML)}else l.context.model.metadata.changed.connect(((t,n)=>{void 0===n.oldValue&&"provenance"===n.key&&(g&&g.dispose(),e.commands.execute("prov-info:open",{title:c,id:d,path:s,cell_id:u,execution_count:p,epoch:m}))}));const t=r.ReactWidget.create(R().createElement(j,{epoch:parseInt(m.toString()),cell:y,infoElements:E,outputElement:b}));(g=s?new K(s,{content:t},m,u,p,null):new K(l.context.path,{content:t},parseInt(m.toString()),u,p,null)).title.label=c||"Execution: "+l.title.label,g.title.closable=!0,g.id=i}N.has(g)||N.add(g),g.isAttached||(e.shell.add(g,"main",{mode:"split-top"}),g.content.update(),e.shell.activateById(g.id))}}),e.commands.addCommand("prov-notebook:open",{execute:t=>{var o,l,{path:a}=t;l="provenance-notebook-widget-"+(o=a?n.find((e=>e.context.path===a)):n.currentWidget).context.path;for(var i,c=e.shell.widgets(),d=c.next();d;)d.id==l?(i=d,d=void 0):d=c.next();if(i&&i.dispose(),!i||i.isDisposed){var u=new s.Widget;o.context.model.metadata.toJSON().provenance?u=r.ReactWidget.create(R().createElement($,{notebookPanel:o})):o.context.model.metadata.changed.connect(((t,n)=>{void 0===n.oldValue&&"provenance"===n.key&&(i&&i.dispose(),e.commands.execute("prov-notebook:open",{path:a}))})),(i=new r.MainAreaWidget({content:u})).title.label="Code info: "+o.title.label,i.title.closable=!0,i.id=l}i.isAttached||(e.shell.add(i,"main"),i.content.update(),e.shell.activateById(i.id))}}),e.commands.addCommand("prov-utils:focus-cell",{execute:e=>{for(var t,{path:o,cell_id:l}=e,a=(t=o?n.find((e=>e.context.path===o)):n.currentWidget).content.model.cells.iter(),r=a.next();r&&r.metadata.toJSON().prov_id!=l;)r=a.next();for(var i=t.content.children(),c=i.next();c&&c._model.id!=r.id;)c=i.next();c&&t.content.scrollToCell(c)}});let S=new r.WidgetTracker({namespace:"provenance"});t.restore(S,{command:f,args:e=>({title:e.title.label,id:e.id,path:e.nbPath}),name:e=>e.id,when:n.restored});let T=new r.WidgetTracker({namespace:"provenance-diff"});t.restore(T,{command:b,args:e=>({title:e.title.label,id:e.id,path:e.nbPath,cell_id:e.cell_id,execution_count:e.execution_count,epoch:e.epoch}),name:e=>e.id,when:n.restored&&S.restored});let N=new r.WidgetTracker({namespace:"provenance-info"});t.restore(N,{command:E,args:e=>({title:e.title.label,id:e.id,path:e.nbPath,cell_id:e.cell_id,execution_count:e.execution_count,epoch:e.epoch,variable:e.variable}),name:e=>e.id,when:n.restored&&S.restored})}}}}]);