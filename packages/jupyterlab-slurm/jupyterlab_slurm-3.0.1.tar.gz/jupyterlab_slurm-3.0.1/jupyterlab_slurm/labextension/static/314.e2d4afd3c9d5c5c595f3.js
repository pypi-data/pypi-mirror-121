"use strict";(self.webpackChunkjupyterlab_slurm=self.webpackChunkjupyterlab_slurm||[]).push([[314],{3314:(e,t,s)=>{s.r(t),s.d(t,{default:()=>C});var a=s(7631),l=s(2727),r=s(9430),o=s(307),i=s(6526),n=s(8218),u=s(6446);async function c(e="",t=new URLSearchParams,s={}){const a=u.ServerConnection.makeSettings();let l=e;t.toString().length>0&&(l=e+"?"+t.toString());const r=n.URLExt.join(a.baseUrl,"jupyterlab_slurm",l);let o;try{o=await u.ServerConnection.makeRequest(r,s,a)}catch(e){console.error("Error with server response: ",r,s,a,e)}let i=null;if(!o.ok)throw i=await o.text(),console.error("Error code: ",o.status),new u.ServerConnection.ResponseError(o,i);if(i=await o.json(),i.length>0)try{console.log("response data",r,t,s,i),i=JSON.parse(i)}catch(a){console.error("requestAPI: Not a JSON response body.",e,t,s,o)}if(!o.ok)throw new u.ServerConnection.ResponseError(o,i.message||i);return i}var d=s(6271),h=s.n(d),m=s(6168),p=s(8174),g=s(3576),b=s(3199),S=s(947),y=s(3491),w=s.n(y);class E extends d.Component{constructor(e){super(e),this.sortRows=this.sortRows.bind(this);let t=this.props.reloadRate;this.props.reloadRate<5e3&&(console.log("jupyterlab-slurm has a floor for reloadRate of 5 seconds, you passed "+this.props.reloadRate),t=5e3);const s=e.defaultColumns?e.defaultColumns:e.availableColumns,a=document.getElementsByTagName("body")[0],l=new MutationObserver((e=>{"true"===e[0].oldValue?this.setState({theme:"dark"}):this.setState({theme:"default"})}));l.observe(a,{attributes:!0,attributeFilter:["data-jp-theme-light"],attributeOldValue:!0}),this.state={rows:[],displayRows:[],selectedRows:[],clearSelected:!1,columns:s,displayColumns:s.map((e=>({name:e,selector:e,sortable:!0,maxWidth:"200px"}))),itemsPerPage:this.props.itemsPerPage,filterQuery:"",lastSqueueFetch:new Date,autoReload:e.autoReload,reloadRate:t,reloadLimit:5e3,userOnly:e.userOnly,loading:!1,theme:"default",observer:l}}clearSelectedRows(){this.setState({selectedRows:[],clearSelected:!0})}toggleUserOnly(){const{userOnly:e}=this.state;this.setState({userOnly:!e})}onSelectedRows(e){this.setState({selectedRows:e.selectedRows,clearSelected:!1})}handleJobAction(e){this.props.processJobAction(e,this.state.selectedRows),"kill"===e&&this.clearSelectedRows()}async getData(e=0){const{userOnly:t}=this.state,s=new URLSearchParams(`userOnly=${t}`);if(e>0){const t=new Date;if(Number(t)-Number(this.state.lastSqueueFetch)<e)return}if(!this.state.loading)return this.setState({loading:!0}),await c("squeue",s).then((e=>{console.log("SqueueDataTable getData() squeue",s,e),this.setState({lastSqueueFetch:new Date,rows:e.data,loading:!1},(()=>{this.updateDisplayRows(),console.log("loading finished")}))})).catch((e=>(console.error("SqueueDataTable getData() error",e),null)))}sortRows(e,t,s){const a=e.slice(0);return a.sort((function(e,a){let l=e[t],r=a[t];if(isNaN(Number(e[t]))||isNaN(Number(a[t]))){if("JOBID"===t){const s=/[0-9][-_[\]]/g,o=String(e[t]).split(s).map((e=>Number(e))),i=String(a[t]).split(s).map((e=>Number(e)));let n,u=0,c=0;for(n=0;n<o.length;n++)u+=o[n];for(n=0;n<i.length;n++)c+=i[n];l=u,r=c}}else l=Number(e[t]),r=Number(a[t]);const o=l>r;return"desc"===s?o?1:-1:o?-1:1})),a}updateDisplayRows(){const e=this.state.rows.filter((e=>{const t=this.state.filterQuery.toLowerCase();for(const s of e)if(s.toLowerCase().includes(t))return!0;return!1})).map((e=>{const t={id:e[0]};let s,a,l;for(s=0,a=0;a<this.state.columns.length;s++,a++)l=this.state.columns[a],t[l]=e[s];return t}));this.setState({displayRows:e})}async onReloadButtonClick(){await this.reload();const e=new Date;Number(e)-Number(this.state.lastSqueueFetch)>=this.state.reloadLimit&&await this.getData()}async reload(){this.setState({clearSelected:!1})}async componentDidMount(){if(await this.getData().then((async()=>{await this.reload()})),this.state.autoReload){const e=async()=>{this.setState({loading:!0}),await this.getData(this.state.reloadRate),this.setState({loading:!1}),setTimeout(e,this.state.reloadRate)};e()}}async componentDidUpdate(e,t){this.state.clearSelected&&this.setState({clearSelected:!1}),this.props.reloadQueue&&this.getData(this.state.reloadLimit),e.reloadQueue&&!this.props.reloadQueue&&this.getData()}componentWillUnmount(){this.state.observer.disconnect()}async handleFilter(e){this.setState({filterQuery:e},this.updateDisplayRows)}render(){return h().createElement(h().Fragment,null,h().createElement(g.Row,{className:"mt-4 justify-content-start jp-SlurmWidget-row"},h().createElement(g.ButtonToolbar,null,h().createElement(g.ButtonGroup,{size:"sm",className:"ml-3 mr-2"},h().createElement(g.Button,{className:"jp-SlurmWidget-table-button",variant:"outline-secondary",onClick:this.onReloadButtonClick.bind(this)},h().createElement(S.cAs,null),"Update Queue"),h().createElement(g.Button,{className:"jp-SlurmWidget-table-button",disabled:0===this.state.selectedRows.length,variant:"outline-secondary",onClick:this.clearSelectedRows.bind(this)},h().createElement(S.zjw,null),"Clear Selected",this.state.selectedRows.length>0&&h().createElement(g.Badge,{variant:"light",pill:!0,className:"jp-SlurmWidget-table-button-badge"},this.state.selectedRows.length))),h().createElement(g.ButtonGroup,{size:"sm"},h().createElement(g.Button,{className:"jp-SlurmWidget-table-button",disabled:0===this.state.selectedRows.length,variant:"outline-danger",onClick:()=>{this.handleJobAction("kill")}},h().createElement(S.dnY,null),"Kill Job(s)",this.state.selectedRows.length>0&&h().createElement(g.Badge,{variant:"light",pill:!0,className:"jp-SlurmWidget-table-button-badge"},this.state.selectedRows.length)),h().createElement(g.Button,{className:"jp-SlurmWidget-table-button",disabled:0===this.state.selectedRows.length,variant:"outline-danger",onClick:()=>{this.handleJobAction("hold")}},h().createElement(S.wRS,null),"Hold Job(s)",this.state.selectedRows.length>0&&h().createElement(g.Badge,{variant:"light",pill:!0,className:"jp-SlurmWidget-table-button-badge"},this.state.selectedRows.length)),h().createElement(g.Button,{className:"jp-SlurmWidget-table-button",disabled:0===this.state.selectedRows.length,variant:"outline-danger",onClick:()=>{this.handleJobAction("release")}},h().createElement(S.W9m,null),"Release Job(s)",this.state.selectedRows.length>0&&h().createElement(g.Badge,{variant:"light",pill:!0,className:"jp-SlurmWidget-table-button-badge"},this.state.selectedRows.length))))),h().createElement(g.Row,{className:"justify-content-start jp-SlurmWidget-row"},h().createElement(g.ButtonToolbar,null,h().createElement(g.Col,{lg:!0},h().createElement(g.InputGroup,{size:"sm",className:"jp-SlurmWidget-table-filter-input-group"},h().createElement(g.InputGroup.Prepend,null,h().createElement(g.InputGroup.Text,{className:"jp-SlurmWidget-table-filter-label"},h().createElement(S.r0X,null),"Filter")),h().createElement(g.FormControl,{className:"jp-SlurmWidget-table-filter-input",value:this.state.filterQuery,onChange:e=>{this.handleFilter(e.target.value)}}))),h().createElement(g.Col,null,h().createElement(g.ToggleButton,{type:"checkbox",className:"jp-SlurmWidget-user-only-checkbox",variant:"outline-light",size:"sm",onChange:this.toggleUserOnly.bind(this),checked:this.state.userOnly,value:"1"},"Display my jobs only"))),h().createElement(g.Col,null,"Last updated: ",this.state.lastSqueueFetch.toLocaleDateString()," ",this.state.lastSqueueFetch.toLocaleTimeString())),this.state.loading&&h().createElement(g.Row,{className:"justify-content-center jp-SlurmWidget-row"},h().createElement("div",{className:"justify-content-center jp-SlurmWidget-squeue-loading"},h().createElement(g.Spinner,{animation:"grow",className:"jp-SlurmWidget-squeue-loader"}))),h().createElement(g.Row,{className:"justify-content-center jp-SlurmWidget-row jp-SlurmWidget-table-row"},h().createElement(w(),{data:this.state.displayRows,columns:this.state.displayColumns,defaultSortField:this.props.availableColumns[0],defaultSortAsc:!1,sortFunction:this.sortRows,striped:!0,highlightOnHover:!0,pagination:!0,selectableRows:!0,clearSelectedRows:this.state.clearSelected,onSelectedRowsChange:this.onSelectedRows.bind(this),noDataComponent:"No jobs currently queued.",paginationPerPage:this.state.itemsPerPage,paginationRowsPerPageOptions:this.props.itemsPerPageOptions,theme:this.state.theme,noHeader:!0,className:"jp-SlurmWidget-table"})))}}class R extends h().Component{constructor(e){super(e),this.state={filebrowser:this.props.filebrowser,fileitems:[],inputType:"path",inputPathSelectType:"dropdown",filepath:"",inlineScript:"",inputTimeout:0},this.updateFilepath=this.updateFilepath.bind(this)}componentDidUpdate(e,t){e.active!==this.props.active&&this.props.active&&this.updateFileitems()}getFileItems(e){const t=[],s=e.model.items();let a,l=s.next();for(;l;)"file"===l.type&&t.push(l.path),l=s.next();return a=t.length>0?t.map((e=>h().createElement("option",{key:e},e))):[h().createElement("option",{key:""},"")],a}updateFileitems(){const e=this.getFileItems(this.state.filebrowser);if(e!==this.state.fileitems){let t;this.setState({fileitems:e});let s=!1;for(t=0;t<e.length;t++)String(e[t].key)===this.state.filepath&&(s=!0);!1===s&&this.setState({filepath:String(e[0].key)})}setTimeout((()=>{this.updateFileitems()}),100)}changeInputType(e){this.setState({inputType:e,inputTimeout:0})}handleFileSelect(e){this.setState({filepath:e.target.value})}updateFilepath(e){this.setState({filepath:e})}updateInlineScript(e){this.setState({inlineScript:e})}handleInputType(e){this.setState({inputType:e})}handleSubmit(){const{inputType:e,filepath:t,inlineScript:s}=this.state,a="path"===e?t:s;this.props.submitJob(a,e),this.props.addAlert("Job submitted","success")}render(){const e=this.state.inputType;return h().createElement(h().Fragment,null,h().createElement(g.Form,null,h().createElement(g.Row,{className:"justify-content-center jp-SlurmWidget-row"},h().createElement("h2",null,"Submit a Batch Job")),h().createElement(g.Row,{className:"justify-content-center"},h().createElement(g.ToggleButtonGroup,{type:"radio",name:"mode-selector",value:e,onChange:this.handleInputType.bind(this)},h().createElement(g.ToggleButton,{value:"path",variant:"outline-secondary"},"Submit a File"),h().createElement(g.ToggleButton,{value:"contents",variant:"outline-secondary"},"Submit Text"))),h().createElement(g.Row,{className:"justify-content-center  jp-SlurmWidget-row"},h().createElement(g.Col,{sm:12},"path"===e&&h().createElement(g.Accordion,{defaultActiveKey:"1"},h().createElement(g.Card,null,h().createElement(g.Accordion.Toggle,{as:g.Card.Header,eventKey:"0",onClick:()=>{this.setState({inputPathSelectType:"textfield"})}},"textfield"===this.state.inputPathSelectType&&h().createElement(S.SZO,null),"dropdown"===this.state.inputPathSelectType&&h().createElement(S.AV3,null),"Type in the path to your slurm script"),h().createElement(g.Accordion.Collapse,{eventKey:"0"},h().createElement(g.Card.Body,null,h().createElement(g.Form.Group,null,h().createElement(g.Form.Control,{type:"text",placeholder:this.props.filebrowser.model.path,onChange:e=>{const t=setTimeout((()=>{this.updateFilepath(e.target.value)}),250);return()=>{clearTimeout(t)}},disabled:this.props.disabled})),h().createElement(g.Button,{variant:"primary",onClick:this.handleSubmit.bind(this),disabled:this.props.disabled},"Submit Job")))),h().createElement(g.Card,null,h().createElement(g.Accordion.Toggle,{as:g.Card.Header,eventKey:"1",onClick:()=>{this.setState({inputPathSelectType:"dropdown"})}},"dropdown"===this.state.inputPathSelectType&&h().createElement(S.SZO,null),"textfield"===this.state.inputPathSelectType&&h().createElement(S.AV3,null),"Choose a slurm script from your current directory"),h().createElement(g.Accordion.Collapse,{eventKey:"1"},h().createElement(g.Card.Body,null,h().createElement(g.Form.Group,null,h().createElement(g.Form.Control,{as:"select",id:"fileselect-dropdown",placeholder:"Select a file",value:this.state.filepath,onChange:this.handleFileSelect.bind(this),disabled:this.props.disabled},this.state.fileitems)),h().createElement(g.Button,{variant:"primary",onClick:this.handleSubmit.bind(this),disabled:this.props.disabled},"Submit Job"))))),"path"!==e&&h().createElement(g.Form.Group,null,h().createElement(g.Form.Label,null,"Enter your Slurm script here"),h().createElement(g.Form.Control,{as:"textarea",rows:30,onChange:e=>this.updateInlineScript(e.target.value),disabled:this.props.disabled}),h().createElement(g.Button,{variant:"primary",onClick:this.handleSubmit.bind(this),disabled:this.props.disabled},"Submit Job"))))))}}class f extends h().Component{constructor(e){super(e),this.requestStatusTable=new Map;const t=e.settings.userOnly,s=e.settings.autoReload,a=e.settings.autoReloadRate,l=e.settings.queueCols;this.JOBID_IDX=l[0],this.processSelectedJobs=this.processSelectedJobs.bind(this),this.makeJobRequest=this.makeJobRequest.bind(this),this.addAlert=this.addAlert.bind(this),this.submitJob=this.submitJob.bind(this),this.state={activeTab:"jobQueue",alerts:[],jobSubmitModalVisible:!1,userOnly:t,jobsPending:0,jobErrors:[],queueCols:l,reloadQueue:!1,autoReload:s,autoReloadRate:a,theme:"default"}}addAlert(e,t){const s=(0,p.uniqueId)("jp-SlurmWidget-alert"),a=h().createElement(g.Alert,{id:s,variant:t,onClose:()=>this.removeAlert(s),dismissible:!0},e);this.setState((e=>({alerts:this.state.alerts.concat([a])})))}removeAlert(e){const t=[];let s;for(s=0;s<this.state.alerts.length;s++)this.state.alerts[s].props.id!==e&&t.push(this.state.alerts[s]);this.setState((e=>({alerts:t})))}async makeJobRequest(e,t,s){const a=(0,b.v4)(),l=JSON.stringify({jobID:s});try{this.requestStatusTable.set(a,"sent"),c(e,new URLSearchParams,{body:l,method:t,headers:{"Content-Type":"application/json"}}).then((async e=>{0===e.returncode?(this.addAlert(e.responseMessage,"success"),this.requestStatusTable.set(a,"received"),this.setState({reloadQueue:!0})):(console.error(e.errorMessage),this.addAlert(e.errorMessage,"danger"),this.requestStatusTable.set(a,"error"))}))}catch(s){console.error(`Error on ${t} ${e}\n${s}`),this.addAlert(`Error on ${t} ${e}\n${s}`,"danger"),this.requestStatusTable.set(a,"error")}}async processSelectedJobs(e,t){const{route:s,method:a}=(e=>{switch(e){case"kill":return{route:"scancel",method:"DELETE"};case"hold":return{route:"scontrol/hold",method:"PATCH"};case"release":return{route:"scontrol/release",method:"PATCH"}}})(e);t.map((async e=>{const t=String(e[this.JOBID_IDX]);this.setState((e=>({jobsPending:e.jobsPending+1}))),await this.makeJobRequest(s,a,t).then((()=>{this.state.jobsPending>0&&this.setState((e=>({jobsPending:e.jobsPending-1})))}))}))}submitJob(e,t){this.setState((e=>({jobSubmitDisabled:!0,jobsPending:this.state.jobsPending+1})));let s,a=this.props.serverRoot;"/"!==a&&(a+="/");const l=a+this.props.filebrowser.model.path,r=encodeURIComponent(l);s="path"!==t||e.startsWith("/")?e:a+e,console.log("Submitting new batch job: ",t,s),c("sbatch",new URLSearchParams(`?inputType=${t}&outputDir=${r}`),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:s})}).then((e=>{let t=!0;0!==e.returncode&&(this.addAlert(""===e.errorMessage?e.responseMessage:e.errorMessage,"danger"),t=!1),this.setState((e=>({reloadQueue:t,jobSubmitDisabled:!1,jobsPending:e.jobsPending-1})))})).catch((e=>{this.addAlert("Unknown error encountered while submitting the script. Try again later. Error: "+e,"danger"),this.setState((e=>({jobSubmitDisabled:!1,jobsPending:e.jobsPending-1})))}))}componentDidUpdate(e,t){this.state.reloadQueue&&0===this.state.jobsPending&&0===t.jobsPending&&this.setState({reloadQueue:!1})}render(){const e=this.state.alerts;return h().createElement("div",{className:"jp-SlurmWidget-main"},h().createElement(g.Tabs,{id:"slurm-tabs",activeKey:this.state.activeTab,onSelect:e=>{this.setState({activeTab:e})}},h().createElement(g.Tab,{title:"Slurm Queue",eventKey:"jobQueue"},h().createElement(E,{processJobAction:this.processSelectedJobs,availableColumns:this.state.queueCols,userOnly:this.state.userOnly,processing:this.state.jobsPending>0,reloadQueue:this.state.reloadQueue,reloadRate:this.state.autoReloadRate,autoReload:this.state.autoReload,itemsPerPage:this.props.settings.itemsPerPage,itemsPerPageOptions:this.props.settings.itemsPerPageOptions})),h().createElement(g.Tab,{title:"Submit Jobs",eventKey:"jobSubmit"},h().createElement(R,{filebrowser:this.props.filebrowser,submitJob:this.submitJob.bind(this),disabled:this.state.jobSubmitDisabled,addAlert:this.addAlert,active:"jobSubmit"===this.state.activeTab})),h().createElement(g.Tab,{className:"jp-SlurmWidget-JobNotifications",title:h().createElement(h().Fragment,null,"Job Notifications",h().createElement(g.Badge,{className:"ml-2",variant:"info"},this.state.alerts.length)),eventKey:"jobHistory"},e)))}}class j extends l.ReactWidget{constructor(e,t){super(),this.userChanged=new m.Signal(this),this.id=(0,p.uniqueId)("slurm-"),this.addClass("jp-SlurmWidget"),this.title.label="Slurm Queue Manager",this.title.closable=!0,this.filebrowser=e,this._settings=t,this.serverRoot=n.PageConfig.getOption("serverRoot")}get user(){return this._user}set user(e){this._user=e,this.userChanged.emit(e)}async fetchUser(){try{c("user").then((e=>({user:e.user}))).catch((e=>{throw console.error("fetchUser error",e),Error(e)}))}catch(e){return console.error(e),{user:"",exception:e.message}}}onAfterAttach(){this.fetchUser()}render(){return h().createElement(l.UseSignal,{signal:this.userChanged},((e,t)=>h().createElement(f,{filebrowser:this.filebrowser,settings:this._settings,serverRoot:this.serverRoot,user:t})))}}s(4039);const v="jupyterlab-slurm:plugin",C={id:v,autoStart:!0,requires:[l.ICommandPalette,a.ILayoutRestorer,o.IFileBrowserFactory,i.ISettingRegistry],optional:[r.ILauncher],activate:async(e,t,s,a,r,o)=>{let i;console.log("JupyterFrontEndPlugin.activate()");const n="slurm:open",u=a.defaultBrowser;console.log("After restore:"),console.log(i);const d={queueCols:[],userOnly:!0,itemsPerPage:10,itemsPerPageOptions:[10,15,20,25,30,40,50],autoReload:!1,autoReloadRate:6e4},h=await r.load(v);var m;console.log(h),m=h,d.queueCols=m.get("queueCols").composite,d.userOnly=m.get("userOnly").composite,d.itemsPerPage=m.get("itemsPerPage").composite,d.itemsPerPageOptions=m.get("itemsPerPageOptions").composite,d.autoReload=m.get("autoReload").composite,d.autoReloadRate=m.get("autoReloadRate").composite,console.log("Loaded UserSettings: "+d);const p=new l.WidgetTracker({namespace:"slurm"});s.restore(p,{command:n,name:()=>"slurm"}),e.commands.addCommand(n,{label:"Slurm Queue Manager",iconClass:"jp-SlurmWidget-NerscLaunchIcon",execute:()=>{i||(console.log(r),i=new j(u,d),i.title.icon="jp-SlurmWidget-NerscTabIcon"),p.has(i)||(p.add(i),console.log("added widget to tracker")),i.isAttached||e.shell.add(i),i.update(),e.shell.activateById(i.id)}}),t.addItem({command:n,category:"HPC Tools",args:{isPalette:!0}}),o&&o.add({command:n,rank:1,category:"HPC Tools"}),c("get_example").then((e=>{console.log("get_example",e)})).catch((e=>{console.error(`The jupyterlab_slurm server extension appears to have a problem starting.\n${e}`)})),c("user").then((e=>{console.log("user",e.user)})).catch((e=>{console.error(`The jupyterlab_slurm server extension appears to have trouble fetching user information.\n${e}`)}))}}}}]);